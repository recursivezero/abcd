---
import { SocialShare } from "astro-social-share";
import ShareIcon from "@/assets/icons/share.svg";
import CopyIcon from "@/assets/icons/Copy.svg";
import "@/assets/styles/SharePopover.css";
---

<div class="share-button-container">
  <button id="shareTrigger" class="share-trigger-button" aria-label="Share" data-tooltip="Share">
    <ShareIcon />
  </button>

  <div id="sharePopover" class="share-popover">
    <SocialShare
      description={Astro.props.description || "Check out this amazing page!"}
      title={Astro.props.title || "My Awesome Page"}
    />
    <button id="copyUrlButton" class="share-option-item copy-link-item">
      <CopyIcon />
      <span>Copy Link</span>
    </button>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const shareTrigger = document.getElementById("shareTrigger")! as HTMLButtonElement;
    const sharePopover = document.getElementById("sharePopover")! as HTMLDivElement;
    const copyUrlButton = document.getElementById("copyUrlButton")! as HTMLButtonElement;

    function togglePopover() {
      sharePopover.classList.toggle("is-open");
      const isExpanded = sharePopover.classList.contains("is-open");
      shareTrigger.setAttribute("aria-expanded", String(isExpanded));
    }

    shareTrigger.addEventListener("click", (event) => {
      event.stopPropagation();
      togglePopover();
    });

    document.addEventListener("click", (event) => {
      if (event.target instanceof Element) {
        if (!sharePopover.contains(event.target) && event.target !== shareTrigger) {
          if (sharePopover.classList.contains("is-open")) {
            togglePopover();
          }
        }
      }
    });

    copyUrlButton.addEventListener("click", async () => {
      const currentUrl = window.location.href;
      try {
        await navigator.clipboard.writeText(currentUrl);
        const originalText = copyUrlButton.querySelector("span")!.textContent;
        copyUrlButton.querySelector("span")!.textContent = "Copied!";
        setTimeout(() => {
          copyUrlButton.querySelector("span")!.textContent = originalText;
        }, 1500);

        togglePopover();
      } catch (err) {
        alert("Failed to copy URL. Please copy it manually: " + currentUrl);
      }
    });
    shareTrigger.setAttribute("aria-expanded", "false");
  });
</script>

---
import stateJson from "@/assets/json/state.json";
import BackButton from "@/components/ui/backButton.astro";
---
<BackButton />
<div class="container__map" style="position: relative;">
  <svg id="india-map" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1500 1800" height="90vh" width="90vw">
    <!-- States will be loaded dynamically -->
  </svg>
  <div id="state-tooltip" class="tooltip"></div>
  <div class="map-toggle-buttons" style="position: absolute; top: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 10;">
    <button id="toggle-rivers" type="button">Show Rivers</button>
    <button id="toggle-labels" type="button">Show Labels</button>
  </div>
</div>
<style>
  .map-toggle-buttons {
    position: absolute;
    top: 20px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 10;
  }
  .map-toggle-buttons button {
    background: #0074e8;
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 10px 18px;
    font-size: 1rem;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: background 0.2s, color 0.2s, box-shadow 0.2s;
    outline: none;
  }
  .map-toggle-buttons button:hover, .map-toggle-buttons button:focus {
    background: #005bb5;
    color: #e0e0e0;
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
  }
</style>
<script define:vars={{ stateJson }} is:inline>
  document.addEventListener("DOMContentLoaded", async () => {
    const indiaSvg = document.getElementById("india-map");
    const tooltip = document.getElementById("state-tooltip");
    const toggleRiversBtn = document.getElementById("toggle-rivers");
    const toggleLabelsBtn = document.getElementById("toggle-labels");

    let visitedStates = JSON.parse(localStorage.getItem("visitedStates") || "[]");
    let riversOverlay = null;
    let labelsOverlay = null;
    let riversVisible = false;
    let labelsVisible = false;

    async function loadStateSVGs() {
      const statesGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
      statesGroup.setAttribute("id", "india-states");

      const fragment = document.createDocumentFragment();

      const statePromises = Object.entries(stateJson).map(async ([stateKey, stateInfo]) => {
        try {
          const response = await fetch(`/map/svg/${stateInfo.svg}`);
          const svgText = await response.text();

          const tempDiv = document.createElement("div");
          tempDiv.innerHTML = svgText;
          const statePaths = tempDiv.querySelectorAll("path");

          statePaths.forEach((path) => {
            const clonedPath = path.cloneNode(true);
            clonedPath.setAttribute("data-state", stateKey);
            clonedPath.setAttribute("data-state-name", stateInfo.name);

            clonedPath.style.fill = visitedStates.includes(stateKey) ? "#aee38a" : "#92ad5c";

            addEventListenersToState(clonedPath, stateInfo, stateKey);
            fragment.appendChild(clonedPath);
          });
        } catch (error) {
          console.error(`Error loading SVG for ${stateKey}:`, error);
        }
      });

      // Wait for all SVGs to load
      await Promise.all(statePromises);

      // Append all states at once
      statesGroup.appendChild(fragment);
      indiaSvg.appendChild(statesGroup);
    }

    function addEventListenersToState(path, stateInfo, stateKey) {
      path.addEventListener("mousemove", (event) => {
        path.style.fill = "#FFA500";
        path.style.transform = "scale(1)";

        tooltip.textContent = stateInfo.name;
        tooltip.style.left = `${event.pageX + 10}px`;
        tooltip.style.top = `${event.pageY + 10}px`;
        tooltip.style.display = "block";
      });
      path.addEventListener("mouseleave", () => {
        path.style.fill = visitedStates.includes(stateKey) ? "#aee38a" : "#92ad5c";
        path.style.transform = "scale(1)";
        tooltip.style.display = "none";
      });

      path.addEventListener("click", (event) => {
        if (!visitedStates.includes(stateKey)) {
          visitedStates.push(stateKey);
          localStorage.setItem("visitedStates", JSON.stringify(visitedStates));
          path.style.fill = "#aee38a";
        }

        const popupEvent = new CustomEvent("showStatePopup", {
          detail: { event, stateInfo }
        });
        document.dispatchEvent(popupEvent);
      });
    }

    async function toggleOverlay(type) {
      const statesGroup = document.getElementById('india-states');
      if (type === 'rivers') {
        if (!riversVisible) {
          if (!riversOverlay) {
            const response = await fetch('/map/svg/river/AllRivers.svg');
            const svgText = await response.text();
            // Parse as SVG
            const parser = new DOMParser();
            const svgDoc = parser.parseFromString(svgText, 'image/svg+xml');
            riversOverlay = svgDoc.querySelector('g');
            if (riversOverlay) {
              riversOverlay.setAttribute('id', 'rivers-overlay');
              riversOverlay.style.pointerEvents = 'none';
            }
          }
          if (riversOverlay) {
            if (statesGroup && statesGroup.nextSibling) {
              indiaSvg.insertBefore(riversOverlay, statesGroup.nextSibling);
            } else {
              indiaSvg.appendChild(riversOverlay);
            }
          }
          toggleRiversBtn.textContent = 'Hide Rivers';
          riversVisible = true;
        } else {
          if (riversOverlay && indiaSvg.contains(riversOverlay)) indiaSvg.removeChild(riversOverlay);
          toggleRiversBtn.textContent = 'Show Rivers';
          riversVisible = false;
        }
      } else if (type === 'labels') {
        if (!labelsVisible) {
          if (!labelsOverlay) {
            const response = await fetch('/map/svg/river/labels.svg');
            const svgText = await response.text();
            // Parse as SVG
            const parser = new DOMParser();
            const svgDoc = parser.parseFromString(svgText, 'image/svg+xml');
            labelsOverlay = svgDoc.querySelector('g');
            if (labelsOverlay) {
              labelsOverlay.setAttribute('id', 'labels-overlay');
              labelsOverlay.style.pointerEvents = 'none';
            }
          }
          if (labelsOverlay) {
            if (statesGroup && statesGroup.nextSibling) {
              indiaSvg.insertBefore(labelsOverlay, statesGroup.nextSibling);
            } else {
              indiaSvg.appendChild(labelsOverlay);
            }
          }
          toggleLabelsBtn.textContent = 'Hide Labels';
          labelsVisible = true;
        } else {
          if (labelsOverlay && indiaSvg.contains(labelsOverlay)) indiaSvg.removeChild(labelsOverlay);
          toggleLabelsBtn.textContent = 'Show Labels';
          labelsVisible = false;
        }
      }
    }

    toggleRiversBtn.addEventListener('click', () => toggleOverlay('rivers'));
    toggleLabelsBtn.addEventListener('click', () => toggleOverlay('labels'));

    loadStateSVGs();
  });
</script>


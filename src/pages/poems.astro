---
import { Debug } from 'astro:components';
import BackIcon from "@/components/Back.astro";
import Help from "@/components/Help.astro";
import SharePopover from "@/components/ShareButton.astro";
import BaseLayout from "@/layouts/Base";
import poem from "@/data/poem.json";
import PoemCard from "@/components/PoemCard.astro";
import "@/assets/styles/poems.css";
import {sortBy} from "@/utils/common.ts"
const { poems } = poem;
sortBy(poems,"title");

---

<BaseLayout meta={{ title: "Poems" }}>
  <BackIcon />
  <Fragment slot="header-right">
    <SharePopover />
    <Help
      title="Poems"
      description="Poems page features a bright, playful design filled with short, themed poems. Children can read & listen to poems. Easy navigation and colorful visuals engaging young readers, parents and teachers alike."
    />
  </Fragment>
  <div class="Container__poems">
    <div class="home_outer">
      <div class="home_start">
        <div class="context">
          <div>Welcome to Poem World!</div>
          <div>Hello, little reader!</div>
        </div>
        <div class="area">
          <ul class="circles">
            <li></li>
            <li></li>
            <li></li>
            <li></li>
            <li></li>
            <li></li>
            <li></li>
            <li></li>
            <li></li>
            <li></li>
          </ul>
        </div>
      </div>
    </div>
    <div class="outer__poem">
      <div class="container__PoemCard">

        {poems.map((poem) => <PoemCard title={poem.title} lines={poem.lines} cute_emoji={poem.cute_emoji} />)}
      </div>
    </div>

    <div id="poem-modal" class="modal hidden">
      <div class="modal-content">
        <span id="close-modal" class="close">&times;</span>
        <button id="audio-toggle" class="speaker-btn" title="Play Poem">ðŸ”‡</button>
        <h2 id="modal-title"></h2>
        <p id="modal-lines"></p>
      </div>
    </div>
  </div>
  <script type="module">
    const modal = document.getElementById("poem-modal");
    const closeBtn = document.getElementById("close-modal");
    const titleEl = document.getElementById("modal-title");
    const linesEl = document.getElementById("modal-lines");
    const audioToggle = document.getElementById("audio-toggle");

    let isMuted = true;
    let currentText = "";
    let currentLang = "en-US";
    let availableVoices = [];
    let voicesLoadedPromise = null;

    function resetSpeakerButton() {
      isMuted = true;
      audioToggle.textContent = "ðŸ”‡";
      window.speechSynthesis.cancel();
    }

    function ensureVoicesLoaded() {
      if (availableVoices.length > 0) return Promise.resolve();
      if (voicesLoadedPromise) return voicesLoadedPromise;

      voicesLoadedPromise = new Promise((resolve) => {
        const voicesNow = speechSynthesis.getVoices();
        if (voicesNow.length > 0) {
          availableVoices = voicesNow;
          resolve();
        } else {
          speechSynthesis.onvoiceschanged = () => {
            availableVoices = speechSynthesis.getVoices();
            resolve();
          };
        }
      });
      return voicesLoadedPromise;
    }

    async function speakPoem() {
      if (!currentText || isMuted) return;
      window.speechSynthesis.cancel();
      await ensureVoicesLoaded();

      if (availableVoices.length === 0) {
        audioToggle.textContent = "ðŸš«";
        return;
      }

      const utterance = new SpeechSynthesisUtterance(currentText);
      let selectedVoice =
        availableVoices.find(
          (v) => v.lang === "en-US" && (v.name.includes("Google") || v.name.includes("Microsoft Zira"))
        ) ||
        availableVoices.find((v) => v.lang === "en-US") ||
        availableVoices[0];

      if (!selectedVoice) {
        audioToggle.textContent = "ðŸš«";
        return;
      }

      utterance.voice = selectedVoice;
      utterance.lang = "en-US";
      utterance.onerror = (event) => console.error("Speech error:", event.error);
      speechSynthesis.speak(utterance);
    }

    window.showPoem = async (title, lines) => {
      titleEl.innerText = title;
      linesEl.innerText = lines.join("\n");
      modal.classList.remove("hidden");

      resetSpeakerButton();
      currentText = lines.join(" ");
      currentLang = "en-US";
      await ensureVoicesLoaded();
      modal.showModal();
    };

    audioToggle.onclick = () => {
      isMuted = !isMuted;
      audioToggle.textContent = isMuted ? "ðŸ”‡" : "ðŸ”Š";
      if (!isMuted) {
        speakPoem();
      } else {
        speechSynthesis.cancel();
      }
    };

    closeBtn.onclick = () => {
      modal.classList.add("hidden");
      resetSpeakerButton();
    };

    window.onclick = (e) => {
      if (e.target === modal) {
        modal.classList.add("hidden");
        resetSpeakerButton();
      }
    };

    ensureVoicesLoaded();
  </script>
</BaseLayout>
